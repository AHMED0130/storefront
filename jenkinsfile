pipeline {
    agent any
    environment {
        IMAGE_NAME = 'ahmed0130/store:3.0-snapshot'
        EC2_INSTANCE = 'ec2-user@16.171.137.39'
    }
    stages {
        stage('Test') {
            steps {
                script {
                    echo "test the application......"
                }
            }
        }
        stage('Build image') {
            steps {
                script {
                    echo "build the app image "

                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
                        sh "docker build -t $IMAGE_NAME ."
                        sh 'echo $PASS | docker login -u $USERNAME --password-stdin'
                        sh "docker push $IMAGE_NAME"
                    }
                }
            }
        }
      stage('Deploy to AWS') {
    steps {
        script {
            echo "Deploying the application to EC2 instance..."

            // Set the EC2 instance IP address
            def EC2_INSTANCE = 'ec2-user@16.171.137.39'

            // Define the shell script to be executed on the remote EC2 instance
            def shellscript = "bash ./script.sh ${IMAGE_NAME}"

            // Create a temporary known_hosts file
            def knownHostsFile = "${JENKINS_HOME}/workspace/storefront@tmp/known_hosts"
            sh "ssh-keyscan -t rsa ${EC2_INSTANCE} > ${knownHostsFile}"

            // Copy Docker Compose file and script to EC2 instance
            sshagent(['ec2-aws-server']) {
                sh "scp -o StrictHostKeyChecking=no -i /var/jenkins_home/workspace/storefront@tmp/private_key_11451060673644021593.key docker-compose.yml ${EC2_INSTANCE}:/home/ec2-user"
                sh "scp -o StrictHostKeyChecking=no -i /var/jenkins_home/workspace/storefront@tmp/private_key_11451060673644021593.key script.sh ${EC2_INSTANCE}:/home/ec2-user"

                // SSH into EC2 instance and run the script
                sh "ssh -o StrictHostKeyChecking=no -i /var/jenkins_home/workspace/storefront@tmp/private_key_11451060673644021593.key ${EC2_INSTANCE} ${shellscript}"
            }
        }
    }
}


    }
}
